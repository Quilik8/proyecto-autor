// =================================================================
// ARCHIVO DE SCRIPT PRINCIPAL PARA EL PROYECTO A.U.T.O.R.
// Versi√≥n 7.0 - Arquitectura Refactorizada y Estable
// =================================================================


// =================================================================
// SECCI√ìN 1: CONFIGURACI√ìN Y FUNCIONES GLOBALES
// =================================================================

const SUPABASE_URL = "https://dyjuvsqghhjtgzbspglz.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5anV2c3FnaGhqdGd6YnNwZ2x6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzMzQwNjksImV4cCI6MjA2ODkxMDA2OX0.FmhuMYeYf4wuJtuwz6XX_ZI3_AORepwp3_bTXRM5c2Y";
const clienteSupabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const toggleFormButtonState = (button, isLoading, originalText) => {
    if (isLoading) {
        button.disabled = true;
        button.textContent = 'Cargando...';
    } else {
        button.disabled = false;
        button.textContent = originalText;
    }
};

const ejecutarScriptsGlobales = async () => {
    configurarMenuHamburguesa();
    configurarInterruptorDeTema();
    configurarBarraDeBusqueda();
    await gestionarEstadoDeSesion();
    configurarBotonDeLogout();
};


// =================================================================
// SECCI√ìN 2: GESTI√ìN DE AUTENTICACI√ìN Y SESI√ìN
// =================================================================

const gestionarEstadoDeSesion = async () => {
    const navElement = document.querySelector('nav');
    const navLogin = document.querySelector("#nav-login");
    const navRegistro = document.querySelector("#nav-registro");
    const navProfile = document.querySelector("#nav-profile");
    const navLogout = document.querySelector("#nav-logout");
    const { data: { session } } = await clienteSupabase.auth.getSession();
    if (session) {
        navProfile?.classList.remove('hidden');
        navLogout?.classList.remove('hidden');
    } else {
        navLogin?.classList.remove('hidden');
        navRegistro?.classList.remove('hidden');
    }
    navElement?.classList.remove('nav-loading');
};

const configurarBotonDeLogout = () => {
    const navLogout = document.querySelector("#nav-logout");
    if (!navLogout) return;
    navLogout.addEventListener('click', async (event) => {
        event.preventDefault();
        await clienteSupabase.auth.signOut();
        window.location.href = 'index.html';
    });
};


// =================================================================
// SECCI√ìN 3: COMPONENTES GLOBALES DE LA INTERFAZ (UI)
// =================================================================

const configurarMenuHamburguesa = () => {
    const hamburger = document.querySelector(".hamburger");
    const navMenu = document.querySelector("nav");
    if (!hamburger || !navMenu) return;
    hamburger.addEventListener("click", () => {
        hamburger.classList.toggle("active");
        navMenu.classList.toggle("active");
    });
};

const configurarInterruptorDeTema = () => {
    const themeToggle = document.getElementById('theme-toggle');
    if (!themeToggle) return;
    const actualizarIcono = () => {
        const esModoOscuro = document.documentElement.classList.contains('dark-mode');
        themeToggle.textContent = esModoOscuro ? '‚òÄÔ∏è' : 'üåô';
    };
    const currentTheme = localStorage.getItem('theme');
    if (currentTheme === 'dark') {
        document.documentElement.classList.add('dark-mode');
    }
    actualizarIcono();
    themeToggle.addEventListener('click', () => {
        document.documentElement.classList.toggle('dark-mode');
        const nuevoTema = document.documentElement.classList.contains('dark-mode') ? 'dark' : 'light';
        localStorage.setItem('theme', nuevoTema);
        actualizarIcono();
    });
};

const configurarBarraDeBusqueda = () => {
    const searchInput = document.getElementById('search-input');
    const searchButton = document.getElementById('search-button');
    if (!searchInput || !searchButton) return;
    const realizarBusqueda = () => {
        const query = searchInput.value.trim();
        if (query) {
            window.location.href = `explorar.html?q=${encodeURIComponent(query)}`;
        }
    };
    searchButton.addEventListener('click', realizarBusqueda);
    searchInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') realizarBusqueda();
    });
};


// =================================================================
// SECCI√ìN 4: L√ìGICA ESPEC√çFICA POR P√ÅGINA
// =================================================================

// --- P√°ginas de Formularios de Usuario (login, registro) ---
const inicializarPaginasDeFormulario = () => {
    const registroForm = document.querySelector("#registro-form");
    if (registroForm) {
        registroForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            const submitButton = registroForm.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.textContent;
            toggleFormButtonState(submitButton, true); // Deshabilitamos el bot√≥n

            const username = document.querySelector("#username").value;
            const email = document.querySelector("#email").value;
            const password = document.querySelector("#password").value;
            const generalError = document.querySelector("#general-error");
            generalError.textContent = "";

            try {
                const { error } = await clienteSupabase.auth.signUp({ email, password, options: { data: { username } } });
                if (error) throw error;
                // Si el registro es exitoso, no necesitamos rehabilitar el bot√≥n porque navegamos a otra p√°gina.
                window.location.href = 'confirmacion.html';
            } catch (error) {
                generalError.textContent = "Error en el registro: " + error.message;
                toggleFormButtonState(submitButton, false, originalButtonText); // Rehabilitamos si hay error
            }
        });
    }

    const loginForm = document.querySelector("#login-form");
     if (loginForm) {
        loginForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            const submitButton = loginForm.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.textContent;
            toggleFormButtonState(submitButton, true); // Deshabilitamos el bot√≥n

            const email = document.querySelector("#login-email").value;
            const password = document.querySelector("#login-password").value;
            const generalError = document.querySelector("#login-general-error");
            generalError.textContent = "";
            try {
                const { error } = await clienteSupabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
                // Si el login es exitoso, navegamos a otra p√°gina.
                window.location.href = 'index.html';
            } catch (error) {
                generalError.textContent = "Correo o contrase√±a incorrectos.";
                toggleFormButtonState(submitButton, false, originalButtonText); // Rehabilitamos si hay error
            }
        });
    }
};

// --- P√°ginas de Visualizaci√≥n de Historias (index, explorar) ---
const inicializarPaginasDeHistorias = async () => {
    const grid = document.querySelector('.featured-stories-grid');
    if (!grid) return;
    
    const params = new URLSearchParams(window.location.search);
    const query = params.get('q');
    try {
        let consulta = clienteSupabase.from('stories').select('*');
        if (query) {
            consulta = consulta.ilike('title', `%${query}%`);
        }
        const { data: stories, error } = await consulta;
        if (error) throw error;
        grid.innerHTML = '';
        if (stories.length === 0) {
            grid.innerHTML = '<p>No se encontraron historias que coincidan con la b√∫squeda.</p>';
        } else {
            stories.forEach(story => {
                const cardHTML = `<a href="historia.html?id=${story.id}" class="story-card-link"><div class="story-card"><img src="${story.cover_image_url || 'https://placehold.co/300x450/26DDC6/1a1a1a?text=Portada'}" alt="Portada de ${story.title}"><h3 class="card-title">${story.title}</h3><p class="card-description">${story.synopsis ? story.synopsis.substring(0, 100) + '...' : ''}</p></div></a>`;
                grid.insertAdjacentHTML('beforeend', cardHTML);
            });
        }
    } catch (error) {
        grid.innerHTML = '<p>No se pudieron cargar las historias.</p>';
    }
};

// --- P√°gina de Detalle de Historia (VERSI√ìN CORREGIDA PARA ENLACES DE PERFIL) ---
const inicializarPaginaDetalleHistoria = async () => {
    const storyPage = document.querySelector('[data-page="detalle-historia"]');
    if (!storyPage) return;

    const params = new URLSearchParams(window.location.search);
    const storyId = params.get('id');
    if (!storyId) {
        document.querySelector('main').innerHTML = '<h1>Error: ID de historia no encontrado.</h1>';
        return;
    }

    try {
        // La consulta ahora pide el 'id' y 'username' del perfil relacionado
        const { data: story, error: storyError } = await clienteSupabase
            .from('stories')
            .select('*, profiles(id, username)') // <-- CAMBIO CLAVE AQU√ç
            .eq('id', storyId)
            .single();

        if (storyError) throw storyError;

        const { data: chapters, error: chaptersError } = await clienteSupabase
            .from('chapters')
            .select('*')
            .eq('story_id', storyId)
            .eq('status', 'publicado')
            .order('chapter_number', { ascending: true });

        if (chaptersError) throw chaptersError;

        // Actualizaci√≥n de la UI
        document.getElementById('story-cover-image').src = story.cover_image_url || 'https://placehold.co/300x450/80E9D9/1a1a1a?text=Portada';
        document.getElementById('story-cover-image').alt = `Portada de ${story.title}`;
        document.getElementById('story-title').textContent = story.title;
        
        // El enlace ahora usa 'story.profiles.id' que est√° garantizado que existe
        const authorElement = document.getElementById('story-author');
        authorElement.innerHTML = `por <a href="perfil.html?id=${story.profiles.id}">${story.profiles.username}</a>`;
        
        document.getElementById('story-meta').textContent = story.genre || 'Sin g√©nero';
        document.getElementById('story-synopsis').textContent = story.synopsis;

        // ... (el resto de la funci√≥n para cargar cap√≠tulos no cambia)
        const chapterList = document.getElementById('chapter-list-ul');
        const startReadingBtn = document.querySelector('.info-column .cta-button');
        chapterList.innerHTML = '';

        if (chapters && chapters.length > 0) {
            chapters.forEach(chapter => {
                chapterList.insertAdjacentHTML('beforeend', `<li><a href="capitulo.html?id=${chapter.id}">${chapter.chapter_number}. ${chapter.title}</a></li>`);
            });
            startReadingBtn.href = `capitulo.html?id=${chapters[0].id}`;
            startReadingBtn.style.display = 'inline-block';
        } else {
            chapterList.innerHTML = '<li>A√∫n no hay cap√≠tulos publicados para esta historia.</li>';
            startReadingBtn.style.display = 'none';
        }

    } catch (error) {
        document.querySelector('main').innerHTML = `<h1>Error al cargar la historia.</h1><p>${error.message}</p>`;
    }
};

// --- P√°gina de Lectura de Cap√≠tulo ---
const inicializarPaginaDeLectura = async () => {
    const chapterContainer = document.querySelector('.reading-container');
    if (!chapterContainer) return;

    const params = new URLSearchParams(window.location.search);
    const chapterId = params.get('id');
    if (!chapterId) {
        chapterContainer.innerHTML = '<h1>Error: ID de cap√≠tulo no encontrado.</h1>';
        return;
    }

    try {
        // 1. Obtenemos los datos del cap√≠tulo actual
        const { data: chapter, error } = await clienteSupabase
            .from('chapters')
            .select('*')
            .eq('id', chapterId)
            .single();

        if (error || !chapter) throw error || new Error('Cap√≠tulo no encontrado');
        
        // 2. Rellenamos el contenido principal
        document.getElementById('chapter-title-h1').textContent = chapter.title;
        document.getElementById('chapter-content-article').innerHTML = `<p>${chapter.content.replace(/\n/g, '</p><p>')}</p>`;

        // 3. Obtenemos la lista completa de cap√≠tulos de la misma historia para la navegaci√≥n
        const { data: allChapters, error: listError } = await clienteSupabase
            .from('chapters')
            .select('id, chapter_number')
            .eq('story_id', chapter.story_id)
            .eq('status', 'publicado') // Solo navegamos entre cap√≠tulos publicados
            .order('chapter_number', { ascending: true });

        if (listError) throw listError;

        // 4. Encontramos la posici√≥n del cap√≠tulo actual en la lista
        const currentIndex = allChapters.findIndex(c => c.id === chapter.id);
        
        // 5. Determinamos el cap√≠tulo anterior y siguiente
        const prevChapter = currentIndex > 0 ? allChapters[currentIndex - 1] : null;
        const nextChapter = currentIndex < allChapters.length - 1 ? allChapters[currentIndex + 1] : null;

        // 6. Actualizamos los enlaces de navegaci√≥n
        if (prevChapter) {
            const prevLink = `capitulo.html?id=${prevChapter.id}`;
            document.getElementById('nav-anterior-top').href = prevLink;
            document.getElementById('nav-anterior-bottom').href = prevLink;
            document.getElementById('nav-anterior-top').style.visibility = 'visible';
            document.getElementById('nav-anterior-bottom').style.visibility = 'visible';
        }

        if (nextChapter) {
            const nextLink = `capitulo.html?id=${nextChapter.id}`;
            document.getElementById('nav-siguiente-top').href = nextLink;
            document.getElementById('nav-siguiente-bottom').href = nextLink;
            document.getElementById('nav-siguiente-top').style.visibility = 'visible';
            document.getElementById('nav-siguiente-bottom').style.visibility = 'visible';
        }

    } catch (error) {
        chapterContainer.innerHTML = `<h1>Error al cargar el cap√≠tulo.</h1><p>${error.message}</p>`;
    }
};

// --- P√°gina de Perfil de Usuario (VERSI√ìN FINAL H√çBRIDA) ---
const inicializarPaginaDePerfil = async () => {
    const profilePageContainer = document.querySelector('.profile-page-container');
    if (!profilePageContainer) return;

    // --- PASO 1: Determinar qu√© perfil mostrar ---
    const params = new URLSearchParams(window.location.search);
    let targetProfileId = params.get('id'); // ID de la URL

    const { data: { session } } = await clienteSupabase.auth.getSession();
    const currentUserId = session ? session.user.id : null;

    // isOwnProfile es true si no hay ID en la URL, o si el ID de la URL coincide con el nuestro.
    const isOwnProfile = !targetProfileId || targetProfileId === currentUserId;

    // Si el usuario intenta ver su propio perfil (sin ID en la URL) pero no tiene sesi√≥n, lo mandamos a login.
    if (isOwnProfile && !currentUserId) {
        window.location.href = 'login.html';
        return;
    }
    
    // Si es su propio perfil, nos aseguramos de que el targetProfileId sea el suyo.
    if (isOwnProfile) {
        targetProfileId = currentUserId;
    }

    // --- PASO 2: Cargar la informaci√≥n p√∫blica del perfil ---
    try {
        const { data: profile, error } = await clienteSupabase
            .from('profiles')
            .select('*')
            .eq('id', targetProfileId)
            .single();

        if (error) throw error;
        
        document.getElementById("profile-username").textContent = profile.username || 'Usuario desconocido';
        document.getElementById("profile-bio").textContent = profile.bio || 'Sin biograf√≠a.';
        document.querySelector(".profile-avatar").src = profile.avatar_url || 'https://placehold.co/150x150/80E9D9/1a1a1a?text=Avatar';
        
        const rolesContainer = document.getElementById('profile-roles-container');
        rolesContainer.innerHTML = ''; 
        if (profile.roles && profile.roles.length > 0) {
            profile.roles.forEach(role => {
                rolesContainer.insertAdjacentHTML('beforeend', `<span class="role-tag">${role}</span>`);
            });
        }
    } catch (error) {
        profilePageContainer.innerHTML = '<h1>Perfil no encontrado</h1><p>El usuario que buscas no existe o ha sido eliminado.</p>';
        return; // Detenemos la ejecuci√≥n si el perfil no carga
    }

        // --- PASO 3: Configurar la UI y cargar datos adicionales seg√∫n la vista ---
    const tabs = document.querySelectorAll('.tab-link');
    const tabContents = document.querySelectorAll('.tab-content');

    // L√≥gica para que las pesta√±as funcionen
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(tc => tc.classList.remove('active'));
            tab.classList.add('active');
            const target = document.getElementById(tab.dataset.tab);
            if (target) {
                target.classList.add('active');
            }
        });
    });

    if (isOwnProfile) {
        // --- VISTA PRIVADA (ES MI PERFIL) ---
        
        // Hacemos visibles los elementos privados
        document.getElementById('edit-profile-btn').classList.remove('hidden');
        document.getElementById('profile-email').classList.remove('hidden');
        document.querySelector('[data-tab="tab-gestion"]').classList.remove('hidden');
        document.querySelector('[data-tab="tab-biblioteca"]').classList.remove('hidden');

        // Forzamos que la pesta√±a de Gesti√≥n sea la activa, revirtiendo el default del HTML.
        document.querySelector('[data-tab="tab-obras"]').classList.remove('active');
        document.getElementById('tab-obras').classList.remove('active');
        document.querySelector('[data-tab="tab-gestion"]').classList.add('active');
        document.getElementById('tab-gestion').classList.add('active');

        document.getElementById('profile-email').textContent = session.user.email;

        // Cargar historias para la pesta√±a de Gesti√≥n
        try {
            const { data: stories, error } = await clienteSupabase
                .from('stories')
                .select('id, title')
                .eq('author_id', currentUserId);
            if (error) throw error;
            
            const storiesListDiv = document.getElementById('gestion-stories-list');
            storiesListDiv.innerHTML = '';
            if (stories && stories.length > 0) {
                stories.forEach(story => {
                    storiesListDiv.insertAdjacentHTML('beforeend', `<div class="management-list-item"><h4>${story.title}</h4><a href="gestionar-historia.html?id=${story.id}" class="cta-button" style="padding: 6px 15px; margin: 0;">Gestionar</a></div>`);
                });
            } else {
                storiesListDiv.innerHTML = '<p>A√∫n no has creado ninguna historia.</p>';
            }
        } catch (error) {
            console.error("Fall√≥ la carga de historias para gesti√≥n:", error.message);
        }

    } else {
        // --- VISTA P√öBLICA (ES EL PERFIL DE OTRO) ---
        document.getElementById('edit-profile-btn').style.display = 'none';
        document.getElementById('profile-email').style.display = 'none';

        // Activar la pesta√±a "Obras P√∫blicas" por defecto
        document.querySelector('[data-tab="tab-gestion"]').classList.remove('active');
        document.getElementById('tab-gestion').classList.remove('active');
        document.querySelector('[data-tab="tab-obras"]').classList.add('active');
        document.getElementById('tab-obras').classList.add('active');
    }

    // --- PASO 4: Cargar datos p√∫blicos para ambas vistas ---

    // Cargar Obras P√∫blicas en la pesta√±a "Obras"
    const obrasContainer = document.getElementById('tab-obras');
    if (obrasContainer) {
        // Preparamos el grid para las tarjetas de historias
        obrasContainer.innerHTML = '<div class="featured-stories-grid"></div>';
        const obrasGrid = obrasContainer.querySelector('.featured-stories-grid');
        
        try {
            const { data: publicStories, error } = await clienteSupabase
                .from('stories')
                .select('*')
                .eq('author_id', targetProfileId);
            
            if (error) throw error;

            if (publicStories && publicStories.length > 0) {
                publicStories.forEach(story => {
                    const cardHTML = `
                        <a href="historia.html?id=${story.id}" class="story-card-link">
                            <div class="story-card">
                                <img src="${story.cover_image_url || 'https://placehold.co/300x450/26DDC6/1a1a1a?text=Portada'}" alt="Portada de ${story.title}">
                                <h3 class="card-title">${story.title}</h3>
                            </div>
                        </a>`;
                    obrasGrid.insertAdjacentHTML('beforeend', cardHTML);
                });
            } else {
                obrasGrid.innerHTML = '<h4 style="grid-column: 1 / -1; text-align: center; font-weight: normal;">Este autor a√∫n no tiene obras p√∫blicas.</h4>';
            }
        } catch (error) {
            console.error("Error al cargar las obras p√∫blicas:", error.message);
            obrasGrid.innerHTML = '<p>No se pudieron cargar las obras.</p>';
        }
    }

    // Cargar Bit√°cora
    const feedContainer = document.getElementById('bitacora-feed-container');
    const cargarBitacora = async () => {
        try {
            const { data: bitacoraEntries, error } = await clienteSupabase
                .from('bitacora')
                .select('*')
                .eq('author_id', targetProfileId)
                .order('created_at', { ascending: false });

            if (error) throw error;
            
            feedContainer.innerHTML = '';

            if (bitacoraEntries.length === 0) {
                feedContainer.innerHTML = '<p>A√∫n no hay entradas en esta bit√°cora.</p>';
            } else {
                bitacoraEntries.forEach(entry => {
                    const esArticulo = entry.type === 'articulo';
                    const fecha = new Date(entry.created_at).toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
                    
                    const deleteButtonHTML = isOwnProfile ? `<a href="#" class="delete-entry-btn" data-entry-id="${entry.id}">Borrar</a>` : '';

                    const entryHTML = `
                        <div class="bitacora-entry ${esArticulo ? 'entry-articulo' : ''}">
                            <div class="bitacora-header">
                                <div>
                                    ${esArticulo ? `<h3 class="bitacora-title">${entry.title}</h3>` : ''}
                                    <span class="entry-meta">${esArticulo ? 'ART√çCULO' : 'APUNTE'} ‚Ä¢ ${fecha}</span>
                                </div>
                                <div class="bitacora-actions">
                                    ${deleteButtonHTML}
                                </div>
                            </div>
                            <div class="bitacora-content">
                                <p>${entry.content}</p>
                            </div>
                        </div>
                    `;
                    feedContainer.insertAdjacentHTML('beforeend', entryHTML);
                });
            }
        } catch (error) {
            feedContainer.innerHTML = '<p>Error al cargar la bit√°cora.</p>';
        }
    };
    
    await cargarBitacora();

    // Listener para borrar entradas (solo se activa si es nuestro propio perfil)
    if (isOwnProfile) {
        feedContainer.addEventListener('click', async (event) => {
            if (event.target && event.target.classList.contains('delete-entry-btn')) {
                event.preventDefault();
                const entryId = event.target.dataset.entryId;
                if (confirm('¬øEst√°s seguro de que quieres borrar esta entrada?')) {
                    try {
                        const { error } = await clienteSupabase.from('bitacora').delete().eq('id', entryId);
                        if (error) throw error;
                        await cargarBitacora();
                    } catch (error) {
                        alert('Error al borrar la entrada: ' + error.message);
                    }
                }
            }
        });
    }
}

// --- P√°gina de Editar Perfil ---
const inicializarPaginaEditarPerfil = async () => {
    const editProfileForm = document.getElementById('edit-profile-form');
    if (!editProfileForm) return;

    const PREDEFINED_ROLES = ['Autor', 'Lector', 'Editor', 'Dise√±ador', 'Traductor', 'Beta-Reader', 'Cr√≠tico'];
    const usernameInput = document.getElementById('username-input');
    const bioInput = document.getElementById('bio-input');
    const rolesContainer = document.getElementById('predefined-roles-container');
    const customRolesInput = document.getElementById('custom-roles-input');
    const avatarPreview = document.getElementById('avatar-preview');
    const avatarInput = document.getElementById('avatar-input');
    const errorDiv = document.getElementById('edit-profile-error');
    const submitButton = editProfileForm.querySelector('button[type="submit"]');
    let newAvatarFile = null;

    rolesContainer.innerHTML = '';
    PREDEFINED_ROLES.forEach(role => {
        const id = `role-${role.toLowerCase().replace(/\s/g, '-')}`;
        rolesContainer.insertAdjacentHTML('beforeend', `
            <div class="role-checkbox-item">
                <input type="checkbox" id="${id}" name="predefined_roles" value="${role}">
                <label for="${id}">${role}</label>
            </div>
        `);
    });

    const { data: { session } } = await clienteSupabase.auth.getSession();
    if (!session) {
        window.location.href = 'login.html';
        return;
    }
    const user = session.user;

    try {
        const { data: profile, error } = await clienteSupabase.from('profiles').select('username, bio, avatar_url, roles').eq('id', user.id).single();
        if (error && error.code !== 'PGRST116') throw error;
        if (profile) {
            usernameInput.value = profile.username || '';
            bioInput.value = profile.bio || '';
            avatarPreview.src = profile.avatar_url || 'https://placehold.co/150x150/80E9D9/1a1a1a?text=Avatar';
            if (profile.roles && profile.roles.length > 0) {
                const customRoles = [];
                profile.roles.forEach(role => {
                    const checkbox = document.querySelector(`input[value="${role}"]`);
                    if (checkbox) checkbox.checked = true;
                    else customRoles.push(role);
                });
                customRolesInput.value = customRoles.join(', ');
            }
        }
    } catch (error) {
        errorDiv.textContent = `Error al cargar el perfil: ${error.message}`;
    }

    avatarInput.addEventListener('change', () => {
        const file = avatarInput.files[0];
        if (file) {
            newAvatarFile = file;
            const reader = new FileReader();
            reader.onload = (e) => { avatarPreview.src = e.target.result; };
            reader.readAsDataURL(file);
        }
    });

    editProfileForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        submitButton.disabled = true;
        submitButton.textContent = 'Guardando...';
        errorDiv.textContent = '';
        try {
            const selectedRoles = Array.from(document.querySelectorAll('input[name="predefined_roles"]:checked')).map(cb => cb.value);
            const customRoles = customRolesInput.value.split(',').map(r => r.trim()).filter(r => r);
            const allRoles = [...new Set([...selectedRoles, ...customRoles])];
            const profileUpdates = { username: usernameInput.value, bio: bioInput.value, roles: allRoles };
            if (newAvatarFile) {
                const fileExt = newAvatarFile.name.split('.').pop();
                const filePath = `${user.id}/avatar.${fileExt}`;
                await clienteSupabase.storage.from('avatars').update(filePath, newAvatarFile, { upsert: true });
                const { data: urlData } = clienteSupabase.storage.from('avatars').getPublicUrl(filePath);
                profileUpdates.avatar_url = urlData.publicUrl + `?t=${new Date().getTime()}`;
            }
            const { error: updateError } = await clienteSupabase.from('profiles').update(profileUpdates).eq('id', user.id);
            if (updateError) throw updateError;
            alert('¬°Perfil actualizado con √©xito!');
            window.location.href = 'perfil.html';
        } catch (error) {
            errorDiv.textContent = `Error al guardar los cambios: ${error.message}`;
            submitButton.disabled = false;
            submitButton.textContent = 'Guardar Cambios';
        }
    });
};

// --- P√°gina de Crear Entrada de Bit√°cora ---
const inicializarPaginaCrearEntrada = async () => {
    const createEntryForm = document.getElementById('create-entry-form');
    if (!createEntryForm) return;

    const typeApunteRadio = document.getElementById('type-apunte');
    const typeArticuloRadio = document.getElementById('type-articulo');
    const titleFormGroup = document.getElementById('title-form-group');
    const entryTitleInput = document.getElementById('entry-title');
    const entryContentInput = document.getElementById('entry-content');
    const contentLabel = document.getElementById('content-label');
    const errorDiv = document.getElementById('create-entry-error');
    const submitButton = createEntryForm.querySelector('button[type="submit"]');

    const toggleTitleField = () => {
        if (typeArticuloRadio.checked) {
            titleFormGroup.classList.remove('hidden');
            contentLabel.textContent = 'Contenido del Art√≠culo';
        } else {
            titleFormGroup.classList.add('hidden');
            contentLabel.textContent = 'Contenido del Apunte';
        }
    };
    typeApunteRadio.addEventListener('change', toggleTitleField);
    typeArticuloRadio.addEventListener('change', toggleTitleField);

    createEntryForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        errorDiv.textContent = '';
        submitButton.disabled = true;
        submitButton.textContent = 'Publicando...';

        const { data: { session } } = await clienteSupabase.auth.getSession();
        if (!session) {
            errorDiv.textContent = "Debes iniciar sesi√≥n para publicar.";
            submitButton.disabled = false;
            submitButton.textContent = 'Publicar Entrada';
            return;
        }

        const type = typeArticuloRadio.checked ? 'articulo' : 'apunte';
        const title = entryTitleInput.value.trim();
        const content = entryContentInput.value.trim();
        
        if (type === 'articulo' && !title) {
            errorDiv.textContent = 'El t√≠tulo es obligatorio para los art√≠culos.';
            submitButton.disabled = false;
            submitButton.textContent = 'Publicar Entrada';
            return;
        }
        if (!content) {
            errorDiv.textContent = 'El contenido no puede estar vac√≠o.';
            submitButton.disabled = false;
            submitButton.textContent = 'Publicar Entrada';
            return;
        }

        try {
            const { error } = await clienteSupabase.from('bitacora').insert({
                author_id: session.user.id,
                type: type,
                title: type === 'articulo' ? title : null,
                content: content
            });
            if (error) throw error;
            alert('¬°Entrada publicada con √©xito!');
            window.location.href = 'perfil.html';
        } catch (error) {
            errorDiv.textContent = `Error al publicar: ${error.message}`;
            submitButton.disabled = false;
            submitButton.textContent = 'Publicar Entrada';
        }
    });
};

// =================================================================
// SECCI√ìN 5: FUNCIONES DE GESTI√ìN DE CONTENIDO (REFACTORIZADAS)
// =================================================================

const inicializarCrearHistoria = async () => {
    const createStoryForm = document.getElementById("create-story-form");
    if (!createStoryForm) return;

    const coverInput = document.getElementById('cover-input');
    const coverPreview = document.getElementById('cover-preview');
    const errorDiv = document.getElementById('create-story-error');
    let newCoverFile = null;

    coverInput.addEventListener('change', () => {
        const file = coverInput.files[0];
        if (file) {
            newCoverFile = file;
            const reader = new FileReader();
            reader.onload = (e) => { coverPreview.src = e.target.result; };
            reader.readAsDataURL(file);
        }
    });

    createStoryForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        errorDiv.textContent = '';
        const { data: { session } } = await clienteSupabase.auth.getSession();
        if (!session) {
            errorDiv.textContent = "Debes iniciar sesi√≥n para crear una historia.";
            return;
        }
        const user = session.user;
        const title = document.querySelector("#story-title-input").value;
        const synopsis = document.querySelector("#story-synopsis-input").value;
        const genre = document.querySelector("#story-genre-input").value;

        if (!title.trim()) {
            errorDiv.textContent = "El t√≠tulo de la historia es obligatorio.";
            return;
        }

        try {
            const { data: newStory, error: insertError } = await clienteSupabase
                .from('stories')
                .insert({ title, synopsis, genre, author_id: user.id })
                .select()
                .single();
            if (insertError) throw insertError;
            
            if (!newCoverFile) {
                 window.location.href = `gestionar-historia.html?id=${newStory.id}`;
                 return;
            }

            const fileExt = newCoverFile.name.split('.').pop();
            const filePath = `${user.id}/${newStory.id}.${fileExt}`;
            const { error: uploadError } = await clienteSupabase.storage.from('covers').upload(filePath, newCoverFile);
            if (uploadError) throw uploadError;

            const { data: urlData } = clienteSupabase.storage.from('covers').getPublicUrl(filePath);
            const { error: updateError } = await clienteSupabase.from('stories').update({ cover_image_url: urlData.publicUrl }).eq('id', newStory.id);
            if (updateError) throw updateError;
            
            window.location.href = `gestionar-historia.html?id=${newStory.id}`;
        } catch (error) {
            errorDiv.textContent = "Error al publicar la historia: " + error.message;
        }
    });
};

const inicializarGestionHistoria = async () => {
    const managementContainer = document.querySelector('#management-page-container');
    if (!managementContainer) return;

    const params = new URLSearchParams(window.location.search);
    const storyId = params.get('id');
    if (!storyId) {
        managementContainer.innerHTML = '<h1>Error: No se encontr√≥ el ID de la historia.</h1>';
        return;
    }

    try {
        const { data: story, error: storyError } = await clienteSupabase.from('stories').select('*').eq('id', storyId).single();
        if (storyError) throw storyError;
        
        const { data: { session } } = await clienteSupabase.auth.getSession();
        if (!session || session.user.id !== story.author_id) {
            managementContainer.innerHTML = '<h1>Acceso Denegado</h1><p>No tienes permiso para gestionar esta historia.</p>';
            return;
        }

        document.getElementById('management-story-title').textContent = `Gestionando: ${story.title}`;
        document.getElementById('manage-title').value = story.title;
        document.getElementById('manage-synopsis').value = story.synopsis;
        document.getElementById('manage-cover-preview').src = story.cover_image_url || 'https://placehold.co/300x450/80E9D9/1a1a1a?text=Portada';
        document.getElementById('add-new-chapter-btn').href = `editar-capitulo.html?story_id=${storyId}`;

        const { data: chapters, error: chaptersError } = await clienteSupabase.from('chapters').select('*').eq('story_id', storyId).order('chapter_number', { ascending: true });
        if (chaptersError) throw chaptersError;

        const chapterCount = chapters.length;
        const publishedCount = chapters.filter(c => c.status === 'publicado').length;
        const totalWords = chapters.reduce((sum, chapter) => (sum + (chapter.content ? chapter.content.trim().split(/\s+/).length : 0)), 0);
        document.getElementById('story-stats-container').innerHTML = `
            <h4>Estad√≠sticas de la Obra</h4>
            <div class="stats-grid">
                <div class="stat-item"><span class="stat-number">${chapterCount}</span><span class="stat-label">Cap√≠tulos</span></div>
                <div class="stat-item"><span class="stat-number">${publishedCount}</span><span class="stat-label">Publicados</span></div>
                <div class="stat-item"><span class="stat-number">${totalWords.toLocaleString('es')}</span><span class="stat-label">Palabras</span></div>
            </div>
        `;

        const chapterListDiv = document.getElementById('management-chapter-list');
        chapterListDiv.innerHTML = '';
        chapters.forEach(chapter => {
            const statusTag = chapter.status === 'borrador' ? `<span class="status-tag draft">Borrador</span>` : '';
            chapterListDiv.insertAdjacentHTML('beforeend', `
                <div class="chapter-management-item">
                    <p>${chapter.chapter_number}. ${chapter.title}${statusTag}</p>
                    <div class="chapter-actions">
                        <a href="editar-capitulo.html?story_id=${storyId}&chapter_id=${chapter.id}">Editar</a>
                        <a href="#" class="delete-chapter-link" data-chapter-id="${chapter.id}" style="color: #e74c3c;">Borrar</a>
                    </div>
                </div>`);
        });

    } catch (error) {
        managementContainer.innerHTML = `<h1>Error al cargar los datos de gesti√≥n.</h1><p>${error.message}</p>`;
    }
};

const inicializarEditarCapitulo = async () => {
    const editorLayout = document.querySelector('.editor-layout');
    if (!editorLayout) return;

    // --- Referencias a Elementos del DOM ---
    const params = new URLSearchParams(window.location.search);
    const storyId = params.get('story_id');
    const chapterId = params.get('chapter_id'); 

    const heading = document.getElementById('editor-heading');
    const chapterListDiv = document.getElementById('editor-chapter-list');
    const backToManagementLink = document.getElementById('back-to-management-link');
    const addNewChapterBtn = document.getElementById('add-new-chapter-editor-btn');
    
    const editorForm = document.getElementById('chapter-editor-form');
    const titleInput = document.getElementById('chapter-title-input');
    const contentInput = document.getElementById('chapter-content-input');
    const saveDraftBtn = document.getElementById('save-draft-btn');
    const deleteChapterBtn = document.getElementById('delete-chapter-btn');
    const editorError = document.getElementById('editor-error');

    if (!storyId) {
        editorLayout.innerHTML = '<h1>Error: ID de historia no encontrado. No se puede cargar el editor.</h1>';
        return;
    }
    backToManagementLink.href = `gestionar-historia.html?id=${storyId}`;
    addNewChapterBtn.href = `editar-capitulo.html?story_id=${storyId}`;

    if (!chapterId) {
        deleteChapterBtn.style.display = 'none';
    }

    try {
        const { data: chapters, error: chaptersError } = await clienteSupabase
            .from('chapters')
            .select('*')
            .eq('story_id', storyId)
            .order('chapter_number', { ascending: true });

        if (chaptersError) throw chaptersError;

        chapterListDiv.innerHTML = '';
        if (chapters && chapters.length > 0) {
            chapters.forEach(chap => {
                // Aqu√≠ usamos chapterId como string, lo cual est√° bien para la comparaci√≥n de clases
                const isActive = chap.id == chapterId; // Usamos '==' que es menos estricto, o podr√≠amos parsear
                const activeClass = isActive ? 'active-chapter' : '';
                const chapterLink = `<a href="editar-capitulo.html?story_id=${storyId}&chapter_id=${chap.id}" class="${activeClass}">${chap.chapter_number}. ${chap.title}</a>`;
                chapterListDiv.insertAdjacentHTML('beforeend', chapterLink);
            });
        } else {
            chapterListDiv.innerHTML = '<p style="padding: 10px;">A√∫n no hay cap√≠tulos.</p>';
        }

        if (chapterId) {
            // ===== LA CORRECCI√ìN EST√Å AQU√ç =====
            const chapterToEdit = chapters.find(c => c.id === parseInt(chapterId));
            
            if (chapterToEdit) {
                heading.textContent = `Editando: ${chapterToEdit.title}`;
                titleInput.value = chapterToEdit.title;
                contentInput.value = chapterToEdit.content;
            } else {
                 heading.textContent = 'Error: Cap√≠tulo no encontrado.';
            }
        } else {
            heading.textContent = 'Creando Nuevo Cap√≠tulo';
        }

        const guardarCapitulo = async (status) => {
            editorError.textContent = '';
            const title = titleInput.value.trim();
            const content = contentInput.value.trim();
            if (!title || !content) {
                editorError.textContent = 'El t√≠tulo y el contenido no pueden estar vac√≠os.';
                return;
            }

            try {
                if (chapterId) {
                    const { error } = await clienteSupabase.from('chapters').update({ title, content, status }).eq('id', chapterId);
                    if (error) throw error;
                    alert('¬°Cap√≠tulo actualizado con √©xito!');
                } else {
                    const newChapterNumber = (chapters ? chapters.length : 0) + 1;
                    const { error } = await clienteSupabase.from('chapters').insert({
                        story_id: storyId,
                        title,
                        content,
                        status,
                        chapter_number: newChapterNumber
                    });
                    if (error) throw error;
                    alert('¬°Cap√≠tulo creado con √©xito!');
                }
                window.location.href = `gestionar-historia.html?id=${storyId}`;
            } catch (error) {
                editorError.textContent = 'Error al guardar el cap√≠tulo: ' + error.message;
            }
        };
        
        editorForm.addEventListener('submit', (event) => {
            event.preventDefault();
            guardarCapitulo('publicado');
        });

        saveDraftBtn.addEventListener('click', () => {
            guardarCapitulo('borrador');
        });

        deleteChapterBtn.addEventListener('click', async () => {
            if (confirm('¬øEst√°s seguro de que quieres borrar este cap√≠tulo? Esta acci√≥n no se puede deshacer.')) {
                try {
                    const { error } = await clienteSupabase.from('chapters').delete().eq('id', chapterId);
                    if (error) throw error;
                    alert('Cap√≠tulo borrado con √©xito.');
                    window.location.href = `gestionar-historia.html?id=${storyId}`;
                } catch (error) {
                    editorError.textContent = 'Error al borrar el cap√≠tulo: ' + error.message;
                }
            }
        });

    } catch (error) {
        editorLayout.innerHTML = `<h1>Error al cargar los datos del editor.</h1><p>${error.message}</p>`;
    }
};

// =================================================================
// SECCI√ìN 6: PUNTO DE ENTRADA DE LA APLICACI√ìN (VERSI√ìN LIMPIA)
// =================================================================
document.addEventListener('DOMContentLoaded', async () => {
    
     const loadComponents = async () => {
        const headerElement = document.querySelector('header');
        const footerElement = document.querySelector('footer');

        // Si existen los elementos, cargamos el contenido
        if (headerElement) {
            try {
                const response = await fetch('header.html');
                if (!response.ok) throw new Error('No se pudo cargar el header.');
                headerElement.innerHTML = await response.text();
            } catch (error) {
                console.error('Error cargando el header:', error);
                headerElement.innerHTML = '<p>Error al cargar el men√∫ de navegaci√≥n.</p>';
            }
        }

        if (footerElement) {
             try {
                const response = await fetch('footer.html');
                if (!response.ok) throw new Error('No se pudo cargar el footer.');
                footerElement.innerHTML = await response.text();
            } catch (error) {
                console.error('Error cargando el footer:', error);
                footerElement.innerHTML = '<p>Error al cargar el pie de p√°gina.</p>';
            }
        }
    };
    
    await loadComponents();
    
    // 1. Los scripts globales siempre se ejecutan
    await ejecutarScriptsGlobales();

    // 2. Obtenemos la p√°gina actual desde el atributo del body
    const currentPage = document.body.dataset.page;

    // 3. Ejecutamos solo el c√≥digo espec√≠fico de la p√°gina
    switch (currentPage) {
        case 'index':
        case 'explorar':
            await inicializarPaginasDeHistorias();
            break;
        case 'registro':
        case 'login':
            inicializarPaginasDeFormulario();
            break;
        case 'detalle-historia':
            await inicializarPaginaDetalleHistoria();
            break;
        case 'lectura':
            await inicializarPaginaDeLectura();
            break;
        case 'perfil':
            await inicializarPaginaDePerfil();
            break;
        case 'editar-perfil':
            await inicializarPaginaEditarPerfil();
            break;
        case 'crear-entrada':
            await inicializarPaginaCrearEntrada();
            break;
        case 'crear-historia':
            await inicializarCrearHistoria();
            break;
        case 'gestion-historia':
            await inicializarGestionHistoria();
            break;
        case 'editar-capitulo':
            await inicializarEditarCapitulo();
            break;
    }
    
    // 4. Hacemos visible el body cuando todo ha cargado
    document.body.classList.remove('body-loading');
});